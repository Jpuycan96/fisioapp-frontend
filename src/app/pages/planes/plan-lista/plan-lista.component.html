<p-toast></p-toast>

<app-page-header title="Planes de Tratamiento" subtitle="Gestión de planes">
  <button pButton label="Nuevo Plan" icon="pi pi-plus" routerLink="/planes/nuevo"></button>
</app-page-header>

<!-- Filtros -->
<div class="filters-card">
  <div class="grid align-items-center">
    <div class="col-12 md:col-4 lg:col-3">
      <label class="block mb-2 font-medium">Estado</label>
      <p-dropdown
        [options]="estadoOptions"
        [(ngModel)]="estadoSeleccionado"
        optionLabel="label"
        optionValue="value"
        placeholder="Todos"
        styleClass="w-full"
        (onChange)="onEstadoChange()">
      </p-dropdown>
    </div>
  </div>
</div>

<!-- Tabla -->
<div class="table-card">
  <p-table
    [value]="planes"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} planes"
    styleClass="p-datatable-sm p-datatable-striped">

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="pacienteNombre">Paciente <p-sortIcon field="pacienteNombre"></p-sortIcon></th>
        <th>Diagnóstico</th>
        <th pSortableColumn="numeroSesiones">Sesiones <p-sortIcon field="numeroSesiones"></p-sortIcon></th>
        <th>Costo</th>
        <th>Modalidad</th>
        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
        <th style="width: 100px;">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-plan>
      <tr>
        <td>
          <a [routerLink]="['/pacientes', plan.pacienteId]" class="paciente-link">
            {{ plan.pacienteNombre }}
          </a>
        </td>
        <td>
          <span class="diagnostico-text">{{ plan.diagnostico | slice:0:50 }}{{ plan.diagnostico.length > 50 ? '...' : '' }}</span>
        </td>
        <td>
          <div class="sesiones-info">
            <span class="sesiones-count">{{ plan.sesionesCompletadas || 0 }}/{{ plan.numeroSesiones }}</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgreso(plan)"></div>
            </div>
          </div>
        </td>
        <td>
          <div class="costo-info">
            @if (plan.porcentajeDescuento > 0) {
              <span class="costo-original">S/. {{ plan.costoTotal | number:'1.2-2' }}</span>
              <span class="costo-final">S/. {{ plan.costoConDescuento | number:'1.2-2' }}</span>
            } @else {
              <span class="costo-final">S/. {{ plan.costoTotal | number:'1.2-2' }}</span>
            }
          </div>
        </td>
        <td>{{ getModalidadLabel(plan.modalidadPago) }}</td>
        <td>
          <p-tag [value]="getEstadoLabel(plan.estado)" [severity]="getEstadoSeverity(plan.estado)"></p-tag>
        </td>
        <td>
          <div class="action-buttons">
            <button
              pButton
              icon="pi pi-eye"
              class="p-button-text p-button-sm p-button-info"
              pTooltip="Ver detalle"
              [routerLink]="['/planes', plan.id]">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <i class="pi pi-file"></i>
            <p>No se encontraron planes de tratamiento</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>